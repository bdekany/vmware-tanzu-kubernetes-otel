apiVersion: opentelemetry.io/v1beta1
kind: OpenTelemetryCollector
metadata:
  name: otelcol-syslog
spec:
  # Mounting our TLS cert+key generated by cert-manager
  volumes:
    - name: syslog-tls
      secret:
        secretName: syslog-otel-tls
  volumeMounts:
    - name: syslog-tls
      mountPath: /tmp/syslog/tls
  # Using contrib image for syslog and opensearch
  image: ghcr.io/open-telemetry/opentelemetry-collector-releases/opentelemetry-collector-contrib
  config:
    extensions:
      # Logn/Pass for Opensearch
      basicauth/client:
        client_auth:
          username: admin
          password: admin
    receivers:
      syslog/tls:
        protocol: rfc5424
        tcp:
          listen_address: "0.0.0.0:6514"
          tls:
            cert_file: /tmp/syslog/tls/tls.crt
            key_file: /tmp/syslog/tls/tls.key
    exporters:
      debug: {}
      opensearch:
        http:
          tls:
            insecure_skip_verify: true
          endpoint: https://my-first-cluster:9200
          auth:
            authenticator: basicauth/client

    service:
      extensions: [basicauth/client]
      pipelines:
        logs:
          receivers: [syslog/tls]
          exporters: [opensearch]
          # exporters: [debug, opensearch]
---
# Create NodePort to access endpoint from outsite the cluster (syslog for OpsMan/TKGi)
apiVersion: v1
kind: Service
metadata:
  labels:
    app: otelcol-syslog-svc
  name: otelcol-syslog-svc
spec:
  ports:
  - name: syslog-6514
    port: 6514
    protocol: TCP
    targetPort: 6514
  selector:
    app.kubernetes.io/name: otelcol-syslog-collector
  type: NodePort
